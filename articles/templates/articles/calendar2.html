{% extends 'base.html' %}

{% block css %}
  <link rel="stylesheet" href="/static/css/calendar2.css">
{% endblock css %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center">
  <div class="my-calendar clearfix">
    {% if user.is_authenticated %}
    <h3 class="mt-3 title_is_user d-flex justify-content-center align-items-center"><b><span style="font-weight:bold;">{{ user.fullname }}</span>ë‹˜ì˜ ë‹¤ì´ì–´ë¦¬ğŸµ</b></h3>
    {% else %}
      <h3 class="mt-3 title_not_user d-flex justify-content-center"><a class="title_not_user_link" href="{% url 'accounts:login' %}">ë¡œê·¸ì¸ í•´ ì£¼ì„¸ìš”!</a></h3>
    {% endif %}
    <div class="clicked-date">
      <div class="cal-day"></div>
      <div class="cal-date"></div>
    </div>
    <div class="calendar-box">
      <div class="ctr-box clearfix">
        <button type="button" title="prev" class="btn-cal prev">
        </button>
        <span class="cal-year"></span>
        <span class="cal-month"></span>
        <button type="button" title="next" class="btn-cal next">
        </button>
      </div>
      <table class="cal-table">
        <thead>
          <tr>
            <th>ì¼</th>
            <th>ì›”</th>
            <th>í™”</th>
            <th>ìˆ˜</th>
            <th>ëª©</th>
            <th>ê¸ˆ</th>
            <th>í† </th>
          </tr>
        </thead>
        <tbody class="cal-body"></tbody>
      </table>
    </div>
  </div>
  <!-- // .my-calendar -->
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  const init = {
  monList: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
  dayList: ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'],
  today: new Date(),
  monForChange: new Date().getMonth(),
  activeDate: new Date(),
  getFirstDay: (yy, mm) => new Date(yy, mm, 1),
  getLastDay: (yy, mm) => new Date(yy, mm + 1, 0),
  nextMonth: function () {
    let d = new Date();
    d.setDate(1);
    d.setMonth(++this.monForChange);
    this.activeDate = d;
    return d;
  },
  prevMonth: function () {
    let d = new Date();
    d.setDate(1);
    d.setMonth(--this.monForChange);
    this.activeDate = d;
    return d;
  },
  addZero: (num) => (num < 10) ? '0' + num : num,
  activeDTag: null,
  getIndex: function (node) {
    let index = 0;
    while (node = node.previousElementSibling) {
      index++;
    }
    return index;
}
};

const $calBody = document.querySelector('.cal-body');
const $btnNext = document.querySelector('.btn-cal.next');
const $btnPrev = document.querySelector('.btn-cal.prev');

/**
 * @param {number} date
 * @param {number} dayIn
*/
function loadDate (date, dayIn) {
  // 0ì´ë©´ ì¼ê¸° ì—†ìŒ
  // 1ì´ë©´ ì¼ê¸° ë³´ëŸ¬ê°€ê¸°
  document.querySelector('.cal-date').textContent = 'ì•ˆë…•';
  document.querySelector('.cal-day').textContent = 'ì´ë‚ ì˜ ì¶”ì–µ ë³´ëŸ¬ê°€ê¸°';
}

{% comment %}
  ë°•ìŠ¤ì— ë‚´ê°€ createí•œ ê²Œì‹œê¸€ í™•ì¸í•˜ëŠ” ê¸€ì„ ë¶ˆëŸ¬ì˜´
  ê²Œì‹œê¸€ì´ ìˆìœ¼ë©´ ê²Œì‹œê¸€ë¡œ ì´ë™
  ì—†ìœ¼ë©´ ì—†ë‹¤ê³  ë‚˜ì˜´.
{% endcomment %}

{% comment %}
  ê²Œì‹œê¸€ì´ ìˆìœ¼ë©´ í•´ë‹¹í•˜ëŠ” ë‚ ì§œì— í‘œì‹œ.
{% endcomment %}

/**
 * @param {date} fullDate
 */
function loadYYMM (fullDate) {
  let yy = fullDate.getFullYear();
  let mm = fullDate.getMonth();
  let firstDay = init.getFirstDay(yy, mm);
  let lastDay = init.getLastDay(yy, mm);
  let markToday;  // for marking today date

  if (mm === init.today.getMonth() && yy === init.today.getFullYear()) {
    markToday = init.today.getDate();
}

document.querySelector('.cal-month').textContent = init.monList[mm];
document.querySelector('.cal-year').textContent = yy + 'ë…„';

// ë‚ ì§œê°€ ì¶”ê°€ë˜ëŠ” ê±°
let trtd = '';
let startCount;
let countDay = 0;
for (let i = 0; i < 6; i++) {
  trtd += '<tr>';
  for (let j = 0; j < 7; j++) {
    if (i === 0 && !startCount && j === firstDay.getDay()) {
      startCount = 1;
    }
    if (!startCount) {
      trtd += '<td>'
    } else {
      let fullDate = yy + '.' + init.addZero(mm + 1) + '.' + init.addZero(countDay + 1);
      trtd += '<td class="day';
      trtd += (markToday && markToday === countDay + 1) ? ' today" ' : '"';
      trtd += ` data-date="${countDay + 1}" data-fdate="${fullDate}"`;
      let tempDate = yy + '-' + init.addZero(mm + 1) + '-' + init.addZero(countDay + 1);
      trtd += `id="${tempDate}"`;
      trtd += `name="${countDay + 1}">`
    }
    trtd += (startCount) ? ++countDay : '';
    if (countDay === lastDay.getDate()) { 
      startCount = 0; 
    }
    trtd += '</td>';
  }
  trtd += '</tr>';
}
$calBody.innerHTML = trtd;
}

// const now_date = document.querySelector('#2022-12-06')
// now_date.addEventListener('click', function() {
//   alert('ë²„íŠ¼ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤');
// })

/**
* @param {string} val
*/
function createNewList (val) {
  let id = new Date().getTime() + '';
  let yy = init.activeDate.getFullYear();
  let mm = init.activeDate.getMonth() + 1;
  let dd = init.activeDate.getDate();
  const $target = $calBody.querySelector(`.day[data-date="${dd}"]`);

  let date = yy + '.' + init.addZero(mm) + '.' + init.addZero(dd);

  let eventData = {};
  eventData['date'] = date;
  eventData['memo'] = val;
  eventData['complete'] = false;
  eventData['id'] = id;
  init.event.push(eventData);
  $todoList.appendChild(createLi(id, val, date));
}

loadYYMM(init.today);
loadDate(init.today.getDate(), init.today.getDay());

document.querySelector('.cal-date').textContent = 'ì•ˆë…•';
document.querySelector('.cal-day').textContent = 'ì´ë‚ ì˜ ì¶”ì–µ ë³´ëŸ¬ê°€ê¸°';

$btnNext.addEventListener('click', () => loadYYMM(init.nextMonth()));
$btnPrev.addEventListener('click', () => loadYYMM(init.prevMonth()));

$calBody.addEventListener('click', (e) => {
if (e.target.classList.contains('day')) {
  if (init.activeDTag) {
    init.activeDTag.classList.remove('day-active');
    // ê° day ë³„ idê°’ ì ‘ê·¼
    target_id = e.target.getAttribute('id')
    console.log(target_id)
    axios({
        method: 'post',
        url: '/articles/id-sort/',
        headers : {'X-CSRFTOKEN' : '{{ csrf_token }}'},
        data: {'target_id': target_id}
      }).then(response => {
        document.querySelector('.cal-date').textContent = response.data.results;
        document.querySelector('.cal-day').textContent = 'ì´ë‚ ì˜ ì¶”ì–µ ë³´ëŸ¬ê°€ê¸°';
      })
  }
  let day = Number(e.target.textContent);
  e.target.classList.add('day-active');
  init.activeDTag = e.target;
  init.activeDate.setDate(day);
}
});

</script>

<div style="height:10rem;"></div>

{% endblock content %}